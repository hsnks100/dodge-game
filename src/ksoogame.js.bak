import Phaser from 'phaser';



var centerY = 32 * 20 / 2.0;
var centerX = 32 * 10 / 2.0;

var bulletSprites = [];
var playerSprite = null;

var upKey = null;
var downKey = null;
var leftKey = null;
var rightKey = null;
var playerSpeed = 3; 
var frameNumber = 0;
var bulletGenInterval = 15;

import wall from './assets/wall.png'
import tail from './assets/tail_bullet.png'
import player from './assets/player.png'

let gameScene = new Phaser.Scene('Game');

var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    scene: gameScene
};

var game = new Phaser.Game(config);

gameScene.create = function() { 
    console.log("phaser: create()");
    playerSprite = this.add.image(0, 0, 'player');
    playerSprite.scaleX = 0.2; 
    playerSprite.scaleY = 0.2; 
    playerSprite.y = 200;
    playerSprite.x = 200;
    playerSprite.anchorX = 0.5; 
    playerSprite.anchorY = 0.5; 

    upKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP);
    downKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.DOWN);
    leftKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT);
    rightKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT);
    this.add.image(30, 45, 'mushroom');
    this.add.image(60, 45, 'mushroom').setAngle(20);
} 

import blueButton1 from './assets/logo.png';
gameScene.preload = function() { 
    this.load.image('wall', wall);
    this.load.image('tail', tail);
    this.load.image('player', player);
    this.load.image('mushroom', blueButton1); // 'assets/pics/akira.jpg');
}

gameScene.update = function() {
    console.log("phaser: update()");
    inputProcess(); 
    moveBullets(); 
    // collisionDetect(); 
    generator(); 
}
function createBullet() { 
    var s = gameScene.add.image(0, 0, 'tail'); 
    s.anchorX = 0.5;
    s.anchorY = 0.5;
    s.custom = {};
    s.custom.radius = 10;
    var sign1 = Math.random() > 0.5 ? 1 : -1;
    var sign2 = Math.random() > 0.5 ? 1 : -1;

    var randomAngle = Math.random() * Math.PI * 2;
    var randomY = Math.cos(randomAngle) * centerY;
    var randomX = Math.sin(randomAngle) * centerX;
    s.y = centerY + randomY;
    s.x = centerX + randomX;
    var dx = playerSprite.x - s.x;
    var dy = playerSprite.y - s.y; 
    s.custom.angle = Math.atan2(dy, dx); 
    s.custom.speed = 1 + Math.random() * 2;
    s.custom.aim = true;
    bulletSprites.push(s); 
}

function collisionDetect() {
    for(var bi in bulletSprites) {
        var b = bulletSprites[bi]; 
        var yDiff = (b.y - playerSprite.y);
        yDiff *= yDiff;

        var xDiff = (b.x - playerSprite.x);
        xDiff *= xDiff; 
        var distance = yDiff + xDiff; 
        if(distance <= 15) {
            //window.alert("puuuuung");
        }
    }
}

function moveBullets() {
    for(var bi in bulletSprites) {
        var b = bulletSprites[bi];
        var yDiff = (b.y - playerSprite.y);
        yDiff *= yDiff;

        var xDiff = (b.x - playerSprite.x);
        xDiff *= xDiff; 
        var distance = yDiff + xDiff; 
        var dx = playerSprite.x - b.x;
        var dy = playerSprite.y - b.y; 
        if(b.custom.aim) {
            if(distance < 30000) {
                console.log("near!");
                b.custom.aim = false;
                b.custom.angle = Math.atan2(dy, dx); 
            }
        }
        b.angle = (b.custom.angle) * 180 / Math.PI + 90;
        b.x += b.custom.speed * Math.cos(b.custom.angle);
        b.y += b.custom.speed * Math.sin(b.custom.angle);
    }
} 

function inputProcess() {
    if(upKey.isDown) {
        playerSprite.y -= playerSpeed;
    }
    if(downKey.isDown) {
        playerSprite.y += playerSpeed;
    }
    if(leftKey.isDown) {
        playerSprite.x -= playerSpeed;
    }
    if(rightKey.isDown) {
        playerSprite.x += playerSpeed;
    } 
}

function generator() {
    frameNumber++;
    if(frameNumber % bulletGenInterval == 5) {
        createBullet();
    }
}



